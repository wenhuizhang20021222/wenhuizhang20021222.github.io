---
title: 七、虚拟内存管理
tags:
  - 操作系统
category:
  - 操作系统
abbrlink: 43908
date: 2022-06-27 23:08:44
---

# 第7章 虚拟内存管理

虚拟内存的概念 

局部性原理

请求分页系统

TLB刷新问题可以忽略

EAT计算，缺页中断，缺页率

==页面分配和替换的算法==  重点： 简单时钟及其变形

后面的基本是概念

局部页面替换：重点掌握局部最佳页面和工作集

抖动

## 1、概念

### （1）局部性原理✳

CPU访问存储器时，无论是存取指令还是存取数据，单元都趋于聚集在一个较小的连续区域中，**局部性体现为**：

1. **时间局部性**：一条指令的一次执行和下次执行， 一个数据的一次访问和下次访问， 都集中在一个较短时间内
2. **空间局部性**：当前执行的指令和将要执行的指令， 当前访问的数据和将要访问的数据， 都集中在一个较小范围内  
3. **顺序局部性**：顺序执行与跳转比例5： 1  

局部性原理是虚拟内存的理论基础

### （2）虚拟内存的定义

> 虚拟内存，也称为虚拟存储器，指具有请求调入和替换功能， 能从逻辑上对内存容量加以扩充的一种存储器系统（是以时间换空间的技术）

**虚拟内存的特征**：

- 离散性：不连续内存分配
- 多次性：一个作业分多次装入内存
- 对换性：允许运行中换进换出
- 虚拟性：逻辑上扩充内存

**常用技术**：

- 请求分页存储管理
- 请求分段存储管理

与前章区别：

- 非请求分页/段：一次性调入
- 请求分页/段：按需调入，不需的换出

## 2、请求分页系统✳

> 请求分页存储管理方法：在分页存储管理的基础上增加了请求调页和页面置换功能 

**支持机构**：

- **物理部件**：内存管理单元（MMU）
- **页表**
- **缺页中断机构**
- **地址变换机构**
- **请求调页和页面置换软件**

**优点**：

- 作业的程序和数据可按页分散存放在内存中，减少移动开销，有效解决碎片问题
- 既有利于改进主存利用率，又有利于多道程序运行

**缺点**：

- 要有硬件支持，进行缺页中断处理，机器成本增加，系统开销加大

### （1）内存管理单元MMU

> MMU：完成逻辑地址到物理地址的转换功能，它接受虚拟地址作为输入，物理地址作为输出，直接送到总线上，对内存单元进行寻址 

<img src="https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291534881.png" alt="image-20220529153445797" style="zoom:50%;" />

**MMU的主要功能**

- 管理硬件页表基址寄存器
- 分解逻辑地址
- 管理快表
- 访问页表
- 发出缺页中断或越界中断，将控制权交给内核存储管理处理
- 管理特征位，设置和检查页表中各个特征位

### （2）页表

与前一章相同，请求分页系统中使用的主要数据结构仍然是页表，但由于每次只将作业的一部分调入内存， 还有一部分内容存放在磁盘上， 故需要在页表中增加若干项，如下表所示：

![image-20220529154142586](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291541612.png)

- 页号和物理块号：其定义同分页存储管理 
- 存在位：用于表示该页是否在主存中 
- 访问字段：用于记录本页在一段时间内被访问的次数， 或最近已有多长时间未被访问
- 修改位：用于表示该页调入内存后是否被修改过
- 外存地址：用于指出该页在外存上的地址

### （3）缺页中断✳

> 在请求分页系统中， 硬件查页表发现所访问的页不在内存时， 便产生缺页中断， 请求OS将缺页调入内存 操作系统执行缺页中断处理程序根据该页在外存的地址把它调入内存 

**缺页中断的处理过程**

![image-20220529154500817](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291545861.png)

如上图所示，包括以下6步

1. **查找页表**：发起对地址的访问，MMU到页表中检查引用情况  
2. **缺页中断**：若不在内存，产生缺页中断，陷入缺页中断程序  
3. **查找外存**：OS在外存中寻找外存中的页面备份
4. **调入内存**：寻找空闲页帧，或依据某种替换算法选择被替换的页帧，将页面调入内存  
5. **修改页表**：修改页表项信息
6. **重新执行**：重新执行产生缺页的指令

**缺页中断与一般中断的区别**

1. 缺页中断在指令的执行期间产生和处理
2. 一条指令可以产生多个缺页中断，例如复制指令copy A to B
3. 缺页中断返回时执行产生中断的指令，一般中断返回时执行下条指令

> 请求分页虚拟存储管理系统的地址变换过程类似于分页存储管理，但当被访问页不在内存时应进行缺页中断处理  

### （4）地址变换

<img src="https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291636817.png" alt="image-20220529163638765" style="zoom:50%;" />

地址变换的数据通路如上图所示，而以下是进行地址变换的流程图

<img src="https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291637270.png" alt="image-20220529163711225" style="zoom:50%;" />

### （5）EAT计算✳✳✳感觉很大概率考！

<img src="https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205291642336.png" alt="image-20220529164207293" style="zoom:50%;" />

> 如上图所示，令查找和修改快表的时间为ε，访存（包括查找页表和访问内存）的时间为t，快表命中率为α，页表缺页率为f，处理缺页中断时间为t1

#### 访问内存时间计算（单次）

1. **若页在主存中且页表项在快表中**：访问时间=查快表时间+访问内存时间=$\epsilon+t$
2. **若页在主存中且页表项不在快表中**：访问时间=查快表时间+查页表时间+修改快表时间
    +访问内存时间=$\epsilon+t+\epsilon+t=2(\epsilon+t)$
3. **若页不在主存之中**：访问时间=查快表时间+查页表时间+处理缺页中断时间t1+查快表时间+访问内存时间 =$\epsilon+t+t_1+\epsilon+t=t_1+2(\epsilon+t)$

#### 有效访问时间计算（多次平均情况）

考虑以上三种情况的概率，其中①出现的概率为α、②出现的概率为(1-α)\*(1-f)、③出现的概率为(1-α)\*f，所以有效访问时间为：
$$
EAT=\alpha*(\epsilon+t)+(1-\alpha)*[(1-f)*2(\epsilon+t)+f*(t_1+2(\epsilon+t))]\\
=(2-\alpha)(\epsilon+t)+(1-\alpha)ft_1
$$

## 3、页面替换

### （1）页面装入与清除策略

**两种页面装入策略**：

- **请求式调度**：按需装入，但是需要频繁的磁盘I/O
- **预调式调度**：利用局部性原理进行动态预测，预先装入

两种页面清除策略：

- **请求式清除**：当一页被选中进行替换且被修改过，则进行写回磁盘，缺点：效率低下
- **预约式清除**：对所有修改的页面，替换前，提前成批写回，要写回的页仍然在主存，直到被替换算法选中此页从主存中移出，若该页面在刚被写回后，在替换回前，再次被大量修改，则该策略失效

**页面的两个来源**：

- **文件区**：用于存放文件，采用离散分配方式
- **对换区**：用于存放对换页面，采用连续分配方式，I/O速度比文件区高

**缺页时的三种情况**：

- **当系统拥有足够的对换区空间**：全部从对换区调入所需页面，以提高调页速度  
- **当系统缺少足够的对换区空间**：这时凡是不会被修改的文件，都直接从文件区调入；而当换出这些页面时，由于它们未被修改而不必再将它们换出，以后再调入时，仍从文件区直接调入，但对于那些可能被修改的部分，在将它们换出时，便须调到对换区，以后需要时，再从对换区调入  
- **UNIX方式**：与进程有关的文件都放在文件区，故凡是未运行过的页面，都应从文件区调入，对于曾经运行过但又被换出的页面，由于是被放在对换区，因此在下次调入时，应从对换区调入                                                                                                                                                                                                                                           

### （2）页面分配与替换策略

**两种页面分配策略**：

- **固定分配**：进程保持页框数固定不变，只要有一个缺页中断产生，进程就会有一页被替换
- **可变分配**：进程分得的页框数可变，如果进程缺页率较高，说明目前局部性较差，可增加分配页框以降低缺页率；反之说明局部性较好，可减少分配页框数

两种页面替换策略：

- **全局替换**：替换算法的作用范围是整个系统，可以在运行的进程之间动态地分配页框
- **局部替换**：替换算法的作用范围局限于本进程，需要为每个进程分配固定的页框

**三种分配和替换算法的配合**

1. **固定分配+局部替换**：容易、但是性能差
2. **可变分配+全局替换**：容易，已经应用于若干操作系统中
3. **可变分配+局部替换**：比较复杂，但是性能好

### （3）页面替换算法✳✳✳必考！

#### 最佳替换算法（OPT）

> 核心思想：淘汰掉将来不再访问， 或者距现在最长时间后才可能会访问的页面  

> 缺点：因页面访问的未来顺序很难精确预测，但算法具有理论意义，可用来评价其他算法的优劣

实例如下：

![image-20220529225933474](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292259528.png)

#### 先进先出算法（FIFO）

> 前提假设：程序按照线性顺序来访问物理空间

> 核心思想：选择调入主存时间最长的页面予以淘汰， 认为驻留时间最长的页面不再使用的可能性较大  

实例如下：

![image-20220529230143996](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292301046.png)

**特点**

- 实现比较简单
- 对按照线性顺序访问的程序比较合适，对其他特性的程序效率不高
- Belady现象：在某些情况下分配给进程的页面数增多，缺页次数反而增加（选择题可能考），其原因是FIFO算法的置换特征与进程访问内存的动态特征是矛盾的， 即被置换的页面并不是进程不会访问的  

**改进**：页面缓冲算法

- 采用FIFO选择被替换页面， 选择出的页面不是立即换出， 而是按照修改与否， 放到相应队列末尾：
    - 空闲队列：页面未修改则放入空闲队列末尾， 该链表也是可直接装入页面的页框所构成  
    - 修改队列：页面已修改则放入修改队列末尾  
- 需要装入的页面被读进空闲队列队首页框中， 而不用等待淘汰页写回再装入  
- 当修改页面到一定数量， 就成批写回， 并把所占用页框挂到空闲链上

#### 最近最久未使用算法（LRU）

> 核心思想：基于局部性原理：刚被使用过的页面可能还会立即被使用， 较长时间内未被使用的页面可能不会立即使用。进行页面替换时，选择最近一段时间内最长时间未被访问过的页面予以淘汰。为了实现，则赋予每个页面一个访问字段， 用于记录页面自上次访问以来所经历的时间， 同时维护一个淘汰队列  

实例如下：

![image-20220529231452025](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292314078.png)

具体实现方法包括：

- **基于计数器的方法**：为每个页表项关联一个时间域字段，为CPU增加一个计数器或者逻辑时钟，每次时钟中断，计数器加1，每当访问一页时，将计数器值复制到相应页所对应页表项的时间域内，当发生缺页中断时，可选择时间域数值最小的对应页面淘汰  
- 基于栈的方法：用一个特殊的栈保存当前进程所访问的各页面号，每当进程访问某页面， 便将它对应的页面号从栈中移出， 压入栈顶，栈顶是最近访问的页面，栈底是最近最久未使用的页面  
- 引用位法：每一个页面关联一个bit，初始为0，当页面被引用时，设置为1，需要替换页面时，替换bit=0的页面
- 附加引用位法（老化算法）：每页都有引用位，并为每页设一个8位内存信息，每隔规定时间，时钟定时器触发中断，将控制权交给OS；OS将每个页的引用位转移到8位字节的高位，并将其他位右移1位，抛弃最低位。这8位就表明了最近8个时间周期，页面的使用情况，发生缺页时挑选最小的为LRU页替换    

#### 二次机会算法

> 核心思想：使用FIFO算法选择一页淘汰时，先检查该页的访问位：
>
> - 如果是0就立即淘汰该页  
> - 如果是1就给它第二次机会， 将其访问位清0，并将它放入页面链的末尾，将其装入时间置为当前时间，然后选择下一个页面  

#### 简单时钟算法

> 核心思想：将页面排成一个循环队列， 类似于时钟表面，并使用一个替换指针，当发生缺页时， 检查指针指向的页面：
>
> - 若其访问位为0，则淘汰该页
> - 否则将该页的访问位清0，指针前移并重复上述过程， 直到找到访问位为0的淘汰页为止；最后指针停留在被替换页的下一页上（如下方流程图所示）

<img src="https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292326018.png" alt="image-20220529232625984" style="zoom:50%;" />

实例如下：

![image-20220529232533212](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292325259.png)

如上图，此时需要替换入page12，则将指针找到的第一个访问位为0的page21淘汰

![image-20220529232811539](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292328587.png)

之所以块2、块3均无*标记，是因为时钟已经转过了块1、2、3，将其标志位置为0，然后替换的是块1

**算法极端情况**：所有页都被引用，则选择时，需要先把所有页面遍历，清除所有引用位，则退化为FIFO

**算法的改进**：考虑修改问题，定义R为访问位，M为修改位，则有以下4种类型：

| R    | M    | 定义               |
| ---- | ---- | ------------------ |
| 0    | 0    | 未被访问也未被修改 |
| 0    | 1    | 未被访问但已被修改 |
| 1    | 0    | 已被访问但未被修改 |
| 1    | 1    | 已被访问且已被修改 |

进行以下3步骤：

1. 从指针当前位置开始扫描循环队列， 寻找R=0， M=0的页面， 将满足条件的第一个页面作为淘汰页， 本轮扫描不修改“访问位R” （若失败， 则所有队列项中：若R=0,M=1；若R=1, M=0/1）
2. 若第1步失败， 则开始第2轮扫描， 寻找R=0， M=1的页面， 将满足条件的第一个页面作为淘汰页， 并将所有经历过页面的访问位R置0（若失败，  则所有队列项中：R=1,M=0/1）
3. 若第2步失败， 则将指针返回到开始位置， 然后重复第1步， 若仍失败则必须重复第2步， 此时一定能找到淘汰页面  

#### 工作集模型

> 核心思想：根据程序的局部性原理，一般情况下，进程在一段时间内总是集中访问一些页面，这些页面称为活跃页面，如果分配给一个进程的物理页面数太少了，使该进程所需的活跃页面不能全部装入内存，则进程在运行过程中将频繁发生中断  
>
> 定义工作集：一个进程当前正在使用的页框集合，用W(T, Δ)表示，即该进程在过去的Δ个虚拟时间单位中访问到的页面的集合，如下方实例所示：
>
> ![image-20220529234937052](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292349087.png)

> 基本思路：找出一个不在工作集之中的页面并置换之

![image-20220529235041046](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292350104.png)

**特点**：概念上好，但监督驻留页面变化的开销很大，估算合适的窗口Δ大小也是个难题  

### 4、抖动问题✳

**定义**：由于频繁缺页，导致运行进程的大部分时间都用于页面的换入/换出，而几乎不能完成任何有效的工作，则称此进程处于抖动状态。抖动又称为颠簸、颤动  

**分为两种**：

1. 局部抖动
2. 全局抖动

**产生原因**：

1. 进程分配的物理块太少
2. 替换算法选择不当
3. 全局替换使抖动传播

**抖动的预防和接触**：

- 采用局部替换策略可以防止抖动传播  
- 通过挂起进程来解除抖动，所选择挂起进程的判断依据：
    - 优先级最低：符合进程调度原则
    - 发生缺页中断的进程：内存不含工作集，缺页时应阻塞
    - 最后被激活的进程：工作集可能不在内存
    - 最大的进程：可释放较多空间  

*不在重点的一个东西：页面大小选择分析*

![image-20220529235508873](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292355923.png)

![image-20220529235516534](https://yzxtuchuang.oss-cn-beijing.aliyuncs.com/img/202205292355578.png)
